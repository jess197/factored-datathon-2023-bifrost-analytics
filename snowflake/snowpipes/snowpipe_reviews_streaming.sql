USE DATABASE MANAGE_DB; 

USE SCHEMA PIPES; 

CREATE OR REPLACE PIPE MANAGE_DB.PIPES.AMAZON_REVIEWS_STREAMING_RAW
    AUTO_INGEST = TRUE
    COMMENT = 'Pipe to autoingest amazon reviews streaming from s3'
 AS 
  COPY INTO AMAZON.RAW.REVIEWS_STREAMING
      FROM (SELECT $1, METADATA$FILE_LAST_MODIFIED, METADATA$FILENAME FROM @MANAGE_DB.EXTERNAL_STAGES.AMAZON_REVIEWS_STREAMING_STAGE_S3) 
      FILE_FORMAT = MANAGE_DB.FILE_FORMATS.JSON_FORMAT
      ON_ERROR = SKIP_FILE;

DESC PIPE AMAZON_REVIEWS_STREAMING_RAW;

SELECT * FROM AMAZON.RAW.REVIEWS_STREAMING;

SELECT SYSTEM$PIPE_STATUS('AMAZON_REVIEWS_STREAMING_RAW');

SELECT * FROM TABLE(validate_pipe_load(
PIPE_NAME => 'MANAGE_DB.PIPES.AMAZON_REVIEWS_STREAMING_RAW',
START_TIME => DATEADD(YEAR,-2,CURRENT_TIMESTAMP())
));

SELECT FILE_NAME, COUNT(*)
  FROM TABLE (INFORMATION_SCHEMA.COPY_HISTORY(
  TABLE_NAME => 'AMAZON.RAW.REVIEWS_STREAMING',
  START_TIME => DATEADD(YEAR,-2,CURRENT_TIMESTAMP())
  ))
  GROUP BY FILE_NAME
  ORDER BY COUNT(*) DESC;  

SELECT * 
  FROM TABLE(INFORMATION_SCHEMA.PIPE_USAGE_HISTORY(
  DATE_RANGE_START=> DATEADD(DAYS,-2,CURRENT_TIMESTAMP()),
  PIPE_NAME => 'MANAGE_DB.PIPES.AMAZON_REVIEWS_STREAMING_RAW'
  ));

ALTER PIPE MANAGE_DB.PIPES.AMAZON_REVIEWS_STREAMING_RAW SET PIPE_EXECUTION_PAUSED = false;

ALTER PIPE MANAGE_DB.PIPES.AMAZON_REVIEWS_STREAMING_RAW REFRESH; 

SELECT * FROM AMAZON.RAW.REVIEWS_STREAMING LIMIT 5000;

SHOW PIPES; 


